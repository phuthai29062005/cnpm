<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Trang cá nhân - Quản lý Dân cư</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #3498db; --secondary: #2c3e50; --success: #27ae60; --danger: #e74c3c; }
        body { background: #f4f6f9; min-height: 100vh; font-family: 'Segoe UI', sans-serif; }
        
        .navbar { background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 15px 0; }
        .navbar-brand { font-weight: 700; color: var(--primary) !important; font-size: 1.4rem; }
        
        .card { border: none; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); overflow: hidden; margin-bottom: 25px; transition: 0.3s; background: white; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .card-header { background: linear-gradient(135deg, var(--primary), #2980b9); color: white; padding: 20px 25px; font-weight: 600; border: none; }
        
        .notification-list { max-height: 500px; overflow-y: auto; }
        .notification-item { display: flex; align-items: flex-start; padding: 20px; border-bottom: 1px solid #f1f1f1; transition: 0.2s; }
        .notification-item:hover { background: #f8f9fa; }
        
        .noti-dot { width: 10px; height: 10px; background-color: var(--primary); border-radius: 50%; margin-top: 6px; margin-right: 15px; flex-shrink: 0; }
        .noti-content strong { color: var(--secondary); display: block; margin-bottom: 4px; font-size: 1rem; }
        .noti-content p { margin: 0; color: #555; font-size: 0.95rem; line-height: 1.5; }
        .noti-time { font-size: 0.8rem; color: #999; margin-top: 8px; display: block; }
        
        .info-label { font-weight: 600; color: #7f8c8d; margin-bottom: 5px; font-size: 0.9rem; text-transform: uppercase; }
        .info-value { font-size: 1.1rem; color: var(--secondary); font-weight: 600; background: #f8f9fa; padding: 10px; border-radius: 8px; border-left: 4px solid var(--primary); }
        
        /* [MỚI] Style cho box chỉ số điện nước */
        .utility-box { display: flex; gap: 20px; margin-bottom: 20px; background: #fdfdfd; padding: 15px; border: 1px dashed #ddd; border-radius: 10px; }
        .utility-item { flex: 1; text-align: center; }
        .utility-icon { font-size: 1.5rem; margin-bottom: 5px; display: block; }
        .utility-value { font-size: 1.2rem; font-weight: bold; color: #2c3e50; }
        
        .btn-pay { background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; border: none; padding: 8px 16px; border-radius: 20px; font-weight: bold; box-shadow: 0 4px 6px rgba(46, 204, 113, 0.2); transition: 0.2s; text-decoration: none; }
        .btn-pay:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(46, 204, 113, 0.3); color: white; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-building me-2"></i>Cư Dân Online</a>
            <div class="d-flex align-items-center gap-3">
                <span class="text-muted d-none d-md-block">Xin chào, <strong>{{ current_user.ho_ten }}</strong></span>
                <a href="{{ url_for('main.receipts') }}" class="btn btn-outline-primary btn-sm"><i class="fas fa-receipt"></i> Biên lai</a>
                <a href="{{ url_for('main.send_request') }}" class="btn btn-outline-warning btn-sm"><i class="fas fa-paper-plane"></i> Gửi yêu cầu</a>
                <a href="{{ url_for('auth.change_password') }}" class="btn btn-light btn-sm text-muted"><i class="fas fa-key"></i></a>
                <a href="{{ url_for('auth.logout') }}" class="btn btn-light btn-sm text-danger"><i class="fas fa-sign-out-alt"></i></a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div style="padding: 20px 0;">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}" style="padding: 15px; border-radius: 8px; margin-bottom: 15px; color: white; background: {{ '#27ae60' if category == 'success' else '#e74c3c' if category == 'danger' else '#f39c12' }}; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <i class="fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-circle' if category == 'danger' else 'info-circle' }}"></i>
                        {{ message }}
                    </div>
                {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        <div class="row g-4">
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-header"><i class="fas fa-bell me-2"></i>Thông báo mới</div>
                    <div class="card-body p-0 notification-list">
                        {% if thong_bao_list %}
                            {% for tb in thong_bao_list %}
                                <div class="notification-item">
                                    <div class="noti-dot"></div>
                                    <div class="noti-content flex-grow-1">
                                        <strong>{{ tb.loai_thong_bao }}</strong>
                                        <p>{{ tb.noi_dung }}</p>
                                        <span class="noti-time">{{ tb.ngay_tao.strftime('%d/%m/%Y %H:%M') }}</span>
                                    </div>
                                    <a href="{{ url_for('main.delete_notification', id=tb.id) }}" class="text-muted ms-2" onclick="return confirm('Xóa thông báo?')"><i class="fas fa-times"></i></a>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center p-5 text-muted">
                                <i class="fas fa-check-circle fa-3x mb-3 text-success" style="opacity: 0.3;"></i>
                                <p>Không có thông báo nào.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header"><i class="fas fa-user me-2"></i>Thông tin cá nhân</div>
                    <div class="card-body">
                        {% if user %}
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="info-label">Họ và tên</div>
                                <div class="info-value">{{ user.ho_ten }}</div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-label">Ngày sinh</div>
                                <div class="info-value">{{ user.ngay_sinh.strftime('%d/%m/%Y') }}</div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-label">Số CCCD</div>
                                <div class="info-value">{{ user.so_cccd }}</div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-label">Nghề nghiệp</div>
                                <div class="info-value">{{ user.nghe_nghiep or 'Chưa cập nhật' }}</div>
                            </div>
                        </div>
                        {% else %}
                            <p class="text-danger">Tài khoản chưa liên kết với dữ liệu Nhân khẩu.</p>
                        {% endif %}
                    </div>
                </div>

                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-home me-2"></i>Thông tin Hộ khẩu</span>
                        {% if hokhau %}<span class="badge bg-white text-primary px-3 py-2">{{ hokhau.ma_so_ho_khau }}</span>{% endif %}
                    </div>
                    <div class="card-body">
                        {% if hokhau %}
                            <p class="mb-3" style="font-size: 1.1rem;"><i class="fas fa-map-marker-alt text-danger me-2"></i><strong>Địa chỉ:</strong> {{ hokhau.so_nha }}, {{ hokhau.duong_pho }}</p>
                            
                            <div class="utility-box">
                                <div class="utility-item">
                                    <i class="fas fa-bolt utility-icon text-warning"></i>
                                    <div class="text-muted small">Chỉ số Điện</div>
                                    <div class="utility-value">{{ hokhau.so_dien }} <small>kWh</small></div>
                                </div>
                                <div class="utility-item" style="border-left: 1px solid #eee;">
                                    <i class="fas fa-tint utility-icon text-primary"></i>
                                    <div class="text-muted small">Chỉ số Nước</div>
                                    <div class="utility-value">{{ hokhau.so_nuoc }} <small>m³</small></div>
                                </div>
                            </div>

                            <h6 class="text-secondary border-bottom pb-2 mb-3 font-weight-bold">Thành viên trong hộ</h6>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light"><tr><th>Họ tên</th><th>Quan hệ</th><th>Ngày sinh</th></tr></thead>
                                    <tbody>
                                        {% for tv in thanh_vien %}
                                        <tr>
                                            <td>{{ tv.nhan_khau.ho_ten }}</td>
                                            <td><span class="badge bg-info text-dark">{{ tv.quan_he_chu_ho }}</span></td>
                                            <td>{{ tv.nhan_khau.ngay_sinh.strftime('%d/%m/%Y') }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            {% if hoa_don_list %}
                                <h6 class="text-danger border-bottom pb-2 mb-3 mt-4"><i class="fas fa-file-invoice-dollar me-2"></i>Hóa đơn chưa thanh toán</h6>
                                <table class="table align-middle">
                                    <tbody>
                                        {% for bill in hoa_don_list %}
                                        <tr>
                                            <td>{{ bill.loai_phi.ten_phi }}</td>
                                            <td class="fw-bold text-danger" style="font-size: 1.1rem;">{{ "{:,.0f}".format(bill.so_tien) }}đ</td>
                                            <td class="text-end">
                                                <a href="{{ url_for('main.pay_online', bill_id=bill.id) }}" class="btn-pay" onclick="return confirm('Xác nhận thanh toán Online?')">
                                                    Thanh toán
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            {% else %}
                                <div class="alert alert-success mt-3 mb-0 d-flex align-items-center"><i class="fas fa-check-circle me-2 fa-lg"></i>Không có khoản phí nào cần đóng.</div>
                            {% endif %}

                        {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-house-user fa-4x text-muted mb-3 opacity-50"></i>
                                <p class="text-muted">Bạn chưa được gán vào Hộ khẩu nào.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>