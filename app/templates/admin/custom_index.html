<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản lý Dân cư</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- CSS GIỮ NGUYÊN & CẢI TIẾN --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        :root { --primary: #3498db; --secondary: #2c3e50; --success: #27ae60; --danger: #e74c3c; --warning: #f39c12; --white: #ffffff; --sidebar-width: 260px; }
        body { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); display: flex; min-height: 100vh; }
        
        .sidebar { width: var(--sidebar-width); background: var(--secondary); color: white; height: 100vh; position: fixed; overflow-y: auto; z-index: 100; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .logo { padding: 25px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 1.4rem; font-weight: bold; background: rgba(0,0,0,0.1); }
        .menu-item { padding: 15px 25px; display: flex; align-items: center; color: #ecf0f1; text-decoration: none; transition: 0.3s; border-left: 4px solid transparent; cursor: pointer; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.05); color: var(--primary); border-left-color: var(--primary); }
        .menu-item i { margin-right: 15px; width: 25px; text-align: center; font-size: 1.1rem; }
        
        .main-content { flex: 1; margin-left: var(--sidebar-width); padding: 30px; transition: 0.3s; }
        
        .header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 40px; height: 40px; background: var(--success); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        
        .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
        .table-title { 
            font-size: 1.5rem; color: var(--secondary); font-weight: 700; 
            position: relative; display: inline-block; padding-bottom: 10px; margin: 0;
        }
        .table-title::after { 
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; 
            background: var(--primary); border-radius: 2px; 
        }
        
        /* SEARCH BAR RIÊNG BIỆT */
        .search-box {
            position: relative;
            min-width: 300px;
        }
        .search-box input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: 0.3s;
        }
        .search-box input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }
        .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #95a5a6; }

        .stats-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .stat-card { 
            background: white; border-radius: 15px; padding: 25px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); text-align: center; 
            transition: 0.3s; border-top: 5px solid var(--primary);
        }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2.5rem; font-weight: 800; color: var(--secondary); margin: 10px 0; }
        .stat-label { color: #95a5a6; font-size: 0.95rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

        .btn { padding: 10px 20px; border-radius: 8px; text-decoration: none; color: white; display: inline-flex; align-items: center; gap: 8px; font-weight: 600; transition: 0.2s; border: none; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); opacity: 0.95; }
        .btn-primary { background: linear-gradient(135deg, #3498db, #2980b9); }
        .btn-success { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .btn-warning { background: linear-gradient(135deg, #f1c40f, #f39c12); }

        .table-container { 
            background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            /* Hỗ trợ cuộn cho danh sách dài như Giao dịch */
            max-height: 600px; overflow-y: auto; 
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 18px 25px; text-align: left; border-bottom: 1px solid #f1f1f1; }
        th { background: #f8f9fa; color: var(--secondary); font-weight: 700; text-transform: uppercase; font-size: 0.85rem; position: sticky; top: 0; z-index: 10; }
        tr:hover { background: #fbfbfb; }
        
        .page-content { display: none; animation: fadeIn 0.4s ease-out; }
        .page-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Modal Style */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(3px); }
        .modal-content { background: white; margin: 5% auto; padding: 30px; border-radius: 15px; width: 80%; max-width: 900px; box-shadow: 0 25px 50px rgba(0,0,0,0.2); animation: slideDown 0.3s; }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close { float: right; font-size: 1.5rem; cursor: pointer; color: #999; }
        .close:hover { color: var(--danger); }
        
        .clickable-row { cursor: pointer; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo"><i class="fas fa-city me-2"></i>QUẢN LÝ DÂN CƯ</div>
        <div class="menu">
            <a class="menu-item active" data-page="dashboard"><i class="fas fa-th-large"></i> Dashboard</a>
            <a class="menu-item" data-page="population"><i class="fas fa-users"></i> Nhân khẩu</a>
            <a class="menu-item" data-page="household"><i class="fas fa-house-user"></i> Hộ khẩu</a>
            <a class="menu-item" data-page="transactions"><i class="fas fa-file-invoice-dollar"></i> Giao dịch</a>
            <a class="menu-item" data-page="temporary"><i class="fas fa-address-card"></i> Tạm trú</a>
            <a class="menu-item" data-page="history"><i class="fas fa-history"></i> Lịch sử</a>
            <a class="menu-item" href="{{ url_for('crud.list_loaiphi') }}"><i class="fas fa-tags"></i> Quản lý Giá</a>
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <h2 id="page-title" style="margin:0; color:var(--secondary);">Dashboard Tổng quan</h2>
            <div class="user-info">
                <strong>{{ current_user.ho_ten }}</strong>
                <div class="user-avatar">{{ current_user.ho_ten[0] }}</div>
                <a href="{{ url_for('auth.logout') }}" class="btn btn-danger" style="padding: 8px 12px;"><i class="fas fa-sign-out-alt"></i></a>
            </div>
        </div>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div style="padding: 20px 0;">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}" style="padding: 15px; border-radius: 8px; margin-bottom: 15px; color: white; background: {{ '#27ae60' if category == 'success' else '#e74c3c' if category == 'danger' else '#f39c12' }}; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <i class="fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-circle' if category == 'danger' else 'info-circle' }}"></i>
                        {{ message }}
                    </div>
                {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <div id="dashboard" class="page-content active">
            <div class="table-header">
                <h2 class="table-title">Chức năng Nhanh</h2>
                <div>
                    <a href="{{ url_for('crud.add_thongbao') }}" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Gửi Thông báo</a>
                    <a href="{{ url_for('crud.upload_billing') }}" class="btn btn-success" style="margin-left: 10px;">
                        <i class="fas fa-file-excel"></i> Thu Phí Excel
                    </a>
                </div>
            </div>
            
            <div class="stats-cards">
                <div class="stat-card" style="border-color:#3498db"><div class="stat-number">{{ total_nhankhau }}</div><div class="stat-label">Tổng Nhân Khẩu</div></div>
                <div class="stat-card" style="border-color:#3498db"><div class="stat-number">{{ total_hokhau }}</div><div class="stat-label">Tổng Hộ Khẩu</div></div>
                <div class="stat-card" style="border-color:#e74c3c"><div class="stat-number text-danger">{{ pending_bills }}</div><div class="stat-label">Hóa đơn chờ</div></div>
                <div class="stat-card" style="border-color:#27ae60"><div class="stat-number text-success">{{ total_doanhthu }}</div><div class="stat-label">Đã thu (VNĐ)</div></div>
            </div>
            
            <div class="table-header" style="margin-top: 40px;">
                <h2 class="table-title">Thống kê Nhân khẩu học</h2>
            </div>
            <div class="stats-cards">
                <div class="stat-card" style="border-color:#9b59b6">
                    <div class="stat-number">{{ stat_gender.Nam }} <small style="font-size:1.5rem; color:#ccc">/</small> {{ stat_gender.Nu }}</div>
                    <div class="stat-label">Nam / Nữ</div>
                </div>
                <div class="stat-card" style="border-color:#f1c40f"><div class="stat-number">{{ stat_age.TreEm }}</div><div class="stat-label">Trẻ em (<15)</div></div>
                <div class="stat-card" style="border-color:#2ecc71"><div class="stat-number">{{ stat_age.LaoDong }}</div><div class="stat-label">Lao động (15-60)</div></div>
                <div class="stat-card" style="border-color:#95a5a6"><div class="stat-number">{{ stat_age.NghiHuu }}</div><div class="stat-label">Về hưu (>60)</div></div>
            </div>
        </div>

        <div id="population" class="page-content">
            <div class="table-header">
                <h2 class="table-title">Quản lý Nhân khẩu</h2>
                <div style="display:flex; gap:10px;">
                    <a href="{{ url_for('crud.khaisinh') }}" class="btn btn-success"><i class="fas fa-baby"></i> Khai sinh</a>
                    <a href="{{ url_for('crud.khaitu') }}" class="btn btn-danger"><i class="fas fa-cross"></i> Khai tử</a>
                    <a href="{{ url_for('crud.add_nhankhau') }}" class="btn btn-primary"><i class="fas fa-plus"></i> Thêm mới</a>
                </div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                <form method="GET" action="{{ url_for('admin.index') }}" style="display:flex; gap:10px;">
                    <input type="search" name="q" placeholder="Tìm kiếm Nhân khẩu (Tên, CCCD)..." value="{{ search_query }}" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:8px;">
                    <input type="hidden" name="tab" value="population">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i> Tìm</button>
                </form>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Họ tên</th><th>Ngày sinh</th><th>Giới tính</th><th>CCCD</th><th>Tình trạng</th><th>Thao tác</th></tr></thead>
                    <tbody>
                        {% for nk in all_nhankhau %}
                        <tr>
                            <td style="font-weight:600;">{{ nk.ho_ten }}</td>
                            <td>{{ nk.ngay_sinh.strftime('%d/%m/%Y') }}</td>
                            <td>{{ nk.gioi_tinh }}</td>
                            <td>{{ nk.so_cccd or '-' }}</td>
                            <td><span style="padding:4px 8px; border-radius:4px; font-size:0.8rem; background: {{ '#ffebee' if nk.tinh_trang=='Qua đời' else '#e8f5e9' }}; color: {{ '#c62828' if nk.tinh_trang=='Qua đời' else '#2e7d32' }}; font-weight:bold;">{{ nk.tinh_trang }}</span></td>
                            <td>
                                <a href="{{ url_for('crud.edit_nhankhau', id=nk.id) }}" style="color:#3498db; margin-right:10px;"><i class="fas fa-edit"></i></a>
                                <a href="{{ url_for('crud.delete_nhankhau', id=nk.id) }}" style="color:#e74c3c;" onclick="return confirm('Xóa?')"><i class="fas fa-trash"></i></a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="household" class="page-content">
            <div class="table-header">
                <h2 class="table-title">Quản lý Hộ khẩu</h2>
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchHousehold" onkeyup="filterTable('searchHousehold', 'tableHousehold')" placeholder="Tìm Mã hộ, Chủ hộ...">
                </div>
                <div>
                    <a href="{{ url_for('crud.split_household') }}" class="btn btn-warning"><i class="fas fa-cut"></i> Tách khẩu</a>
                    <a href="{{ url_for('crud.add_hokhau') }}" class="btn btn-primary"><i class="fas fa-plus"></i> Thêm Hộ</a>
                </div>
            </div>
            <div class="table-container">
                <table id="tableHousehold">
                    <thead><tr><th>Mã HK</th><th>Chủ hộ</th><th>Địa chỉ</th><th>Số TV</th><th>Thao tác</th></tr></thead>
                    <tbody>
                        {% for hk in all_hokhau %}
                        <tr class="household-row" data-id="{{ hk.id }}">
                            <td style="color:var(--primary); font-weight:bold;">{{ hk.ma_so_ho_khau }}</td>
                            <td>{{ hk.chu_ho.ho_ten if hk.chu_ho else '---' }}</td>
                            <td>{{ hk.so_nha }}, {{ hk.duong_pho }}</td>
                            <td><span style="background:#e3f2fd; color:#1565c0; padding:3px 10px; border-radius:12px; font-weight:bold; font-size:0.85rem;">{{ hk.member_links|length }} TV</span></td>
                            <td>
                                <button onclick="toggleHouseholdDetail({{ hk.id }}); event.stopPropagation();" class="btn btn-success" style="padding:6px 12px; font-size:0.8rem;"><i class="fas fa-eye"></i> Chi tiết</button>
                                <a href="{{ url_for('crud.edit_hokhau', id=hk.id) }}" class="btn btn-primary" style="padding:6px 12px; font-size:0.8rem;" onclick="event.stopPropagation();"><i class="fas fa-edit"></i></a>
                                <a href="{{ url_for('crud.delete_hokhau', id=hk.id) }}" class="btn btn-danger" style="padding:6px 12px; font-size:0.8rem;" onclick="event.stopPropagation(); return confirm('Xóa?')"><i class="fas fa-trash"></i></a>
                            </td>
                        </tr>
                        <tr id="detail-hk-{{ hk.id }}" class="household-detail" style="display:none;">
                            <td colspan="5" style="background:#f8f9fa; padding:25px;">
                                <div style="background:white; padding:20px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                                    <h2 style="color:var(--secondary); border-bottom:3px solid var(--primary); padding-bottom:10px; margin-bottom:20px; display:inline-block;">
                                        Hộ khẩu: {{ hk.ma_so_ho_khau }}
                                    </h2>
                                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:25px; background:#e3f2fd; padding:15px; border-radius:8px;">
                                        <div><strong>Chủ hộ:</strong> <span style="color:var(--danger); font-weight:bold;">{{ hk.chu_ho.ho_ten if hk.chu_ho else 'Chưa có' }}</span></div>
                                        <div><strong>Địa chỉ:</strong> {{ hk.so_nha }}, {{ hk.duong_pho }}</div>
                                        <div><strong>Điện:</strong> {{ hk.so_dien }} kWh</div>
                                        <div><strong>Nước:</strong> {{ hk.so_nuoc }} m³</div>
                                    </div>
                                    <h3 style="margin-bottom:15px; color:#555;"><i class="fas fa-users"></i> Danh sách thành viên ({{ hk.member_links|length }} người)</h3>
                                    <div style="max-height:300px; overflow-y:auto; border:1px solid #ddd; border-radius:8px;">
                                        <table style="width:100%; border:none;">
                                            <thead style="background:#2c3e50; color:white; position:sticky; top:0;"><tr><th>Họ tên</th><th>Quan hệ</th><th>Ngày sinh</th><th>CCCD</th><th>Nghề nghiệp</th></tr></thead>
                                            <tbody>
                                                {% for link in hk.member_links %}
                                                <tr style="border-bottom:1px solid #eee;">
                                                    <td style="padding:12px;"><strong>{{ link.nhan_khau.ho_ten }}</strong></td>
                                                    <td style="padding:12px;">{{ link.quan_he_chu_ho }}</td>
                                                    <td style="padding:12px;">{{ link.nhan_khau.ngay_sinh.strftime('%d/%m/%Y') }}</td>
                                                    <td style="padding:12px;">{{ link.nhan_khau.so_cccd or '-' }}</td>
                                                    <td style="padding:12px;">{{ link.nhan_khau.nghe_nghiep or '-' }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div style="margin-top:20px; text-align:right; display:flex; gap:10px; justify-content:flex-end;">
                                        <a href="{{ url_for('crud.add_member_to_hokhau') }}?hokhau_id={{ hk.id }}" class="btn btn-success"><i class="fas fa-user-plus"></i> Thêm thành viên</a>
                                        <button class="btn btn-secondary" onclick="toggleHouseholdDetail({{ hk.id }})"><i class="fas fa-times"></i> Đóng</button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="temporary" class="page-content">
            <div class="table-header">
                <h2 class="table-title">Quản lý Tạm trú</h2>
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchTemp" onkeyup="filterTable('searchTemp', 'tableTemp')" placeholder="Tìm người, địa chỉ...">
                </div>
                <a href="{{ url_for('crud.add_tamtru') }}" class="btn btn-primary">Đăng ký</a>
            </div>
            <div class="table-container">
                <table id="tableTemp">
                    <thead><tr><th>Họ tên</th><th>CCCD</th><th>Địa chỉ tạm trú</th><th>Hạn tạm trú</th><th>Thao tác</th></tr></thead>
                    <tbody>
                        {% for tt in all_tamtru %}
                        <tr>
                            <td>{{ tt.resident.ho_ten }}</td>
                            <td>{{ tt.resident.so_cccd or '-' }}</td>
                            <td>{{ tt.noi_tam_tru }}</td>
                            <td><span style="color:var(--warning); font-weight:bold;">{{ tt.ngay_ket_thuc.strftime('%d/%m/%Y') }}</span></td>
                            <td><a href="{{ url_for('crud.delete_tamtru', id=tt.id) }}" class="text-danger"><i class="fas fa-trash"></i></a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="transactions" class="page-content">
             <div class="table-header">
                 <h2 class="table-title">Giao dịch</h2>
                 <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchTrans" onkeyup="filterTable('searchTrans', 'tableTrans')" placeholder="Tìm Hộ, Loại phí...">
                </div>
             </div>
             <div class="table-container" style="max-height: 600px; overflow-y: auto;">
                <table id="tableTrans">
                    <thead><tr><th>Hộ</th><th>Phí</th><th>Tiền</th><th>Trạng thái</th><th>Thao tác</th></tr></thead>
                    <tbody>
                        {% for gd in all_giaodich %}
                        <tr>
                            <td>{{ gd.ho_khau.ma_so_ho_khau if gd.ho_khau else 'N/A' }}</td>
                            <td>{{ gd.loai_phi.ten_phi }}</td>
                            <td>{{ "{:,.0f}".format(gd.so_tien) }}</td>
                            <td><span class="badge" style="background:{{ 'rgba(46, 204, 113,0.2)' if gd.trang_thai=='Đã thanh toán' else 'rgba(231, 76, 60,0.2)' }}; color:{{ 'green' if gd.trang_thai=='Đã thanh toán' else 'red' }}; padding:4px 8px; border-radius:4px;">{{ gd.trang_thai }}</span></td>
                            <td>
                                {% if gd.trang_thai == 'Đang chờ' %}
                                <a href="{{ url_for('crud.pay_bill', gd_id=gd.id) }}" class="btn btn-success" style="padding:5px 10px; font-size:0.8rem;">Thu</a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
             </div>
        </div>
        
        <div id="history" class="page-content">
            <div class="table-header"><h2 class="table-title">Lịch sử & Yêu cầu</h2><a href="{{ url_for('crud.list_requests') }}" class="btn btn-primary">Chi tiết</a></div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Ngày</th><th>Người gửi</th><th>Nội dung</th><th>Trạng thái</th></tr></thead>
                    <tbody>
                        {% for req in all_requests %}
                        <tr>
                            <td>{{ req.ngay_gui.strftime('%d/%m') }}</td>
                            <td>{{ req.nguoi_gui.ho_ten }}</td>
                            <td>{{ req.loai_yeu_cau }}</td>
                            <td>{{ req.trang_thai }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // HÀM TÌM KIẾM CỰC NHANH CHO TABLE
        function filterTable(inputId, tableId) {
            var input, filter, table, tr, td, i, txtValue;
            input = document.getElementById(inputId);
            filter = input.value.toUpperCase();
            table = document.getElementById(tableId);
            tr = table.getElementsByTagName("tr");

            // Duyệt qua tất cả các dòng, ẩn dòng không khớp
            for (i = 0; i < tr.length; i++) {
                // Bỏ qua dòng tiêu đề (thead)
                if (tr[i].getElementsByTagName("th").length > 0) continue;

                var match = false;
                // Kiểm tra tất cả các cột trong dòng
                var tds = tr[i].getElementsByTagName("td");
                for (var j = 0; j < tds.length; j++) {
                    if (tds[j]) {
                        txtValue = tds[j].textContent || tds[j].innerText;
                        if (txtValue.toUpperCase().indexOf(filter) > -1) {
                            match = true;
                            break; 
                        }
                    }
                }
                
                if (match) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }

        // Tab Handling
        document.querySelectorAll('.menu-item[data-page]').forEach(item => {
            item.addEventListener('click', function(e) {
                document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
                document.getElementById(this.getAttribute('data-page')).classList.add('active');
            });
        });

        // URL Param Handling
        const urlParams = new URLSearchParams(window.location.search);
        const tab = urlParams.get('tab');
        if(tab) {
            const menu = document.querySelector(`.menu-item[data-page="${tab}"]`);
            if(menu) menu.click();
        }

        // Modal Logic (giữ cho các modal khác nếu có)
        function openModal(id) { document.getElementById(id).style.display = "block"; }
        function closeModal(id) { document.getElementById(id).style.display = "none"; }
        window.onclick = function(e) { if (e.target.classList.contains('modal')) e.target.style.display = "none"; }
        
        // Toggle Household Detail - Expand/Collapse trong bảng
        function toggleHouseholdDetail(id) {
            const detailRow = document.getElementById(`detail-hk-${id}`);
            const allRows = document.querySelectorAll('.household-row');
            const allDetails = document.querySelectorAll('.household-detail');
            
            // Nếu đang mở detail này, thì đóng nó và hiện tất cả rows lại
            if (detailRow.style.display === 'table-row') {
                detailRow.style.display = 'none';
                allRows.forEach(row => row.style.display = 'table-row');
            } else {
                // Đóng tất cả details khác
                allDetails.forEach(detail => detail.style.display = 'none');
                
                // Ẩn tất cả các hộ khác
                allRows.forEach(row => {
                    if (row.getAttribute('data-id') != id) {
                        row.style.display = 'none';
                    }
                });
                
                // Hiện detail của hộ được chọn
                detailRow.style.display = 'table-row';
            }
        }
    </script>
</body>
</html>